# æ•°æ®è¿ç§»æŒ‡å—

## æ¦‚è¿°

æœ¬æ¬¡ä¼˜åŒ–å°†æ’­æ”¾è®°å½•å’Œæ”¶è—çš„å­˜å‚¨ç»“æ„ä»**ç‹¬ç«‹ key** è¿ç§»åˆ° **Redis Hash**ï¼Œä»¥è§£å†³æ€§èƒ½é—®é¢˜ã€‚

### æ€§èƒ½æå‡

- **æŸ¥è¯¢é€Ÿåº¦**: 10ç§’ â†’ 0.1-0.5ç§’ (æå‡ 95%+)
- **Redis æ“ä½œ**: ä» `KEYS + MGET` (é˜»å¡) â†’ `HGETALL` (å•æ¬¡æ“ä½œ)
- **ç½‘ç»œå¾€è¿”**: ä» 80+ æ¬¡ â†’ 1 æ¬¡

### å­˜å‚¨ç»“æ„å˜åŒ–

#### æ—§ç»“æ„ (ç‹¬ç«‹ key)

```
u:username:pr:source1+id1 â†’ JSON
u:username:pr:source2+id2 â†’ JSON
...
u:username:fav:source1+id1 â†’ JSON
u:username:fav:source2+id2 â†’ JSON
```

#### æ–°ç»“æ„ (Hash)

```
u:username:playrecords â†’ Hash {
  "source1+id1": JSON,
  "source2+id2": JSON,
  ...
}

u:username:favorites â†’ Hash {
  "source1+id1": JSON,
  "source2+id2": JSON,
  ...
}
```

---

## è¿ç§»æ­¥éª¤

### 1. å‡†å¤‡å·¥ä½œ

ç¡®ä¿å·²å®‰è£…ä¾èµ–:

```bash
pnpm install
```

è®¾ç½®ç¯å¢ƒå˜é‡:

```bash
# Redis
export REDIS_URL="redis://localhost:6379"

# æˆ– Upstash
export UPSTASH_REDIS_REST_URL="your-upstash-url"
```

### 2. é¢„è§ˆè¿ç§» (æ¨è)

å…ˆè¿è¡Œé¢„è§ˆæ¨¡å¼ï¼ŒæŸ¥çœ‹å°†è¦è¿ç§»çš„æ•°æ®:

```bash
# ä½¿ç”¨ npm
npm run migrate:preview

# æˆ–ä½¿ç”¨ pnpm
pnpm migrate:preview

# æˆ–ç›´æ¥è®¾ç½®ç¯å¢ƒå˜é‡
DRY_RUN=true pnpm tsx scripts/migrate-to-hash.ts
```

è¾“å‡ºç¤ºä¾‹:

```
ğŸš€ å¼€å§‹æ•°æ®è¿ç§»...

æ¨¡å¼: é¢„è§ˆæ¨¡å¼ï¼ˆä¸ä¼šä¿®æ”¹æ•°æ®ï¼‰
åˆ é™¤æ—§ key: å¦

âœ… å·²è¿æ¥åˆ° Redis

ğŸ“Š å‘ç° 5 ä¸ªç”¨æˆ·

ğŸ‘¤ å¤„ç†ç”¨æˆ·: alice
  ğŸ“¼ å‘ç° 80 æ¡æ’­æ”¾è®°å½•
  [é¢„è§ˆæ¨¡å¼] å°†è¿ç§»åˆ°: u:alice:playrecords
  â­ å‘ç° 15 æ¡æ”¶è—
  [é¢„è§ˆæ¨¡å¼] å°†è¿ç§»åˆ°: u:alice:favorites
  âœ… å®Œæˆ
...
```

### 3. æ‰§è¡Œè¿ç§»

ç¡®è®¤æ— è¯¯åï¼Œæ‰§è¡Œå®é™…è¿ç§»:

```bash
# ä½¿ç”¨ npm
npm run migrate

# æˆ–ä½¿ç”¨ pnpm
pnpm migrate

# æˆ–ç›´æ¥è¿è¡Œ
pnpm tsx scripts/migrate-to-hash.ts
```

**æ³¨æ„**: é»˜è®¤ä¼šä¿ç•™æ—§ keyï¼Œä»¥ä¾¿å›æ»šã€‚

### 4. éªŒè¯è¿ç§»

è¿è¡ŒéªŒè¯è„šæœ¬æ£€æŸ¥æ•°æ®å®Œæ•´æ€§:

```bash
# ä½¿ç”¨ npm
npm run migrate:verify

# æˆ–ä½¿ç”¨ pnpm
pnpm migrate:verify

# æˆ–ç›´æ¥è¿è¡Œ
pnpm tsx scripts/verify-migration.ts
```

è¾“å‡ºç¤ºä¾‹:

```
ğŸ” å¼€å§‹éªŒè¯æ•°æ®è¿ç§»...

âœ… å·²è¿æ¥åˆ° Redis

ğŸ“Š å‘ç° 5 ä¸ªç”¨æˆ·

ğŸ‘¤ alice
  âœ… æ’­æ”¾è®°å½•: æ—§=80, æ–°=80
  âœ… æ”¶è—: æ—§=15, æ–°=15
...

============================================================
ğŸ“ˆ éªŒè¯ç»Ÿè®¡:
============================================================
æ€»ç”¨æˆ·æ•°:           5
æ—§æ’­æ”¾è®°å½•æ€»æ•°:     320
æ–°æ’­æ”¾è®°å½•æ€»æ•°:     320
æ—§æ”¶è—æ€»æ•°:         75
æ–°æ”¶è—æ€»æ•°:         75
============================================================

âœ… éªŒè¯é€šè¿‡ï¼æ‰€æœ‰æ•°æ®å·²æˆåŠŸè¿ç§»åˆ°æ–°ç»“æ„
```

### 5. æµ‹è¯•æ–°ç»“æ„

åœ¨ç”Ÿäº§ç¯å¢ƒæµ‹è¯•åº”ç”¨æ˜¯å¦æ­£å¸¸å·¥ä½œ:

- è®¿é—®é¦–é¡µï¼Œæ£€æŸ¥"ç»§ç»­è§‚çœ‹"æ˜¯å¦æ­£å¸¸æ˜¾ç¤º
- æ’­æ”¾è§†é¢‘ï¼Œæ£€æŸ¥æ’­æ”¾è®°å½•æ˜¯å¦æ­£å¸¸ä¿å­˜
- æ£€æŸ¥æ”¶è—åŠŸèƒ½æ˜¯å¦æ­£å¸¸

### 6. åˆ é™¤æ—§ key (å¯é€‰)

ç¡®è®¤æ–°ç»“æ„å·¥ä½œæ­£å¸¸åï¼Œåˆ é™¤æ—§ key é‡Šæ”¾ç©ºé—´:

```bash
# Windows (PowerShell)
$env:DELETE_OLD_KEYS="true"; pnpm migrate

# Linux/Mac
DELETE_OLD_KEYS=true pnpm migrate

# æˆ–ä½¿ç”¨ cross-env (è·¨å¹³å°)
pnpm cross-env DELETE_OLD_KEYS=true tsx scripts/migrate-to-hash.ts
```

---

## å¿«é€Ÿå‘½ä»¤å‚è€ƒ

```bash
# é¢„è§ˆè¿ç§» (ä¸ä¿®æ”¹æ•°æ®)
npm run migrate:preview

# æ‰§è¡Œè¿ç§» (ä¿ç•™æ—§key)
npm run migrate

# éªŒè¯è¿ç§»
npm run migrate:verify

# åˆ é™¤æ—§key (Windows PowerShell)
$env:DELETE_OLD_KEYS="true"; npm run migrate

# åˆ é™¤æ—§key (Linux/Mac)
DELETE_OLD_KEYS=true npm run migrate
```

---

## å›æ»šæ–¹æ¡ˆ

å¦‚æœæ–°ç»“æ„å‡ºç°é—®é¢˜ï¼Œå¯ä»¥ä¸´æ—¶å›æ»šåˆ°æ—§ä»£ç :

1. **Git å›æ»šä»£ç **:

```bash
git revert HEAD
```

2. **é‡æ–°éƒ¨ç½²**

3. **æ—§ key ä»ç„¶å­˜åœ¨**ï¼Œåº”ç”¨ä¼šè‡ªåŠ¨ä½¿ç”¨æ—§æ•°æ®

---

## å¸¸è§é—®é¢˜

### Q: è¿ç§»éœ€è¦å¤šé•¿æ—¶é—´?

A: å–å†³äºæ•°æ®é‡ã€‚é€šå¸¸æ¯ä¸ªç”¨æˆ· < 1ç§’ï¼Œ100ä¸ªç”¨æˆ·çº¦ 1-2 åˆ†é’Ÿã€‚

### Q: è¿ç§»ä¼šå½±å“çº¿ä¸ŠæœåŠ¡å—?

A: è¿ç§»è„šæœ¬æ˜¯ç‹¬ç«‹è¿è¡Œçš„ï¼Œä¸ä¼šå½±å“åº”ç”¨ã€‚ä½†å»ºè®®åœ¨ä½å³°æœŸæ‰§è¡Œã€‚

### Q: å¦‚æœè¿ç§»ä¸­æ–­æ€ä¹ˆåŠ?

A: è„šæœ¬æ”¯æŒé‡å¤è¿è¡Œï¼Œå·²è¿ç§»çš„æ•°æ®ä¼šè¢«è¦†ç›–ï¼ˆå¹‚ç­‰æ“ä½œï¼‰ã€‚

### Q: æ–°æ—§ç»“æ„å¯ä»¥å…±å­˜å—?

A: ä¸èƒ½ã€‚ä»£ç å·²ä¿®æ”¹ä¸ºåªä½¿ç”¨æ–°ç»“æ„ï¼Œæ—§ key ä»…ç”¨äºè¿ç§»å’Œå›æ»šã€‚

### Q: Upstash Redis æ”¯æŒå—?

A: å®Œå…¨æ”¯æŒã€‚ä½¿ç”¨ `UPSTASH_REDIS_REST_URL` ç¯å¢ƒå˜é‡å³å¯ã€‚

### Q: npm å’Œ pnpm éƒ½å¯ä»¥ç”¨å—?

A: æ˜¯çš„ã€‚é¡¹ç›®å·²æ·»åŠ  npm scriptsï¼Œä¸¤è€…éƒ½æ”¯æŒ:

- `npm run migrate:preview` æˆ– `pnpm migrate:preview`
- `npm run migrate` æˆ– `pnpm migrate`
- `npm run migrate:verify` æˆ– `pnpm migrate:verify`

---

## æŠ€æœ¯ç»†èŠ‚

### è¿ç§»è„šæœ¬ (`migrate-to-hash.ts`)

- è‡ªåŠ¨å‘ç°æ‰€æœ‰ç”¨æˆ·
- æ‰¹é‡è¯»å–æ—§æ•°æ® (`MGET`)
- æ‰¹é‡å†™å…¥æ–° Hash (`HSET` + pipeline)
- å¯é€‰åˆ é™¤æ—§ key
- å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œç»Ÿè®¡

### éªŒè¯è„šæœ¬ (`verify-migration.ts`)

- å¯¹æ¯”æ—§ç»“æ„å’Œæ–°ç»“æ„çš„æ•°æ®é‡
- é€ç”¨æˆ·éªŒè¯æ•°æ®å®Œæ•´æ€§
- ç”Ÿæˆè¯¦ç»†çš„éªŒè¯æŠ¥å‘Š

### ä»£ç ä¿®æ”¹ (`redis-base.db.ts`)

- `getPlayRecord`: `GET` â†’ `HGET`
- `setPlayRecord`: `SET` â†’ `HSET`
- `getAllPlayRecords`: `KEYS + MGET` â†’ `HGETALL`
- `deletePlayRecord`: `DEL` â†’ `HDEL`
- æ”¶è—åŠŸèƒ½åŒç†

---

## ç›‘æ§å»ºè®®

è¿ç§»åå»ºè®®ç›‘æ§ä»¥ä¸‹æŒ‡æ ‡:

1. **API å“åº”æ—¶é—´**: `/api/playrecords` åº”ä» 3-10ç§’é™è‡³ 0.1-0.5ç§’
2. **Redis æ…¢æŸ¥è¯¢**: ä¸åº”å†å‡ºç° `KEYS` å‘½ä»¤
3. **ç”¨æˆ·åé¦ˆ**: é¡µé¢åŠ è½½é€Ÿåº¦åº”æ˜æ˜¾æå‡

---

## è”ç³»æ”¯æŒ

å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·æŸ¥çœ‹:

- è„šæœ¬è¾“å‡ºçš„é”™è¯¯æ—¥å¿—
- Redis æœåŠ¡å™¨æ—¥å¿—
- åº”ç”¨æ—¥å¿— (`console.log`)

æˆ–æäº¤ Issue åˆ°é¡¹ç›®ä»“åº“ã€‚
